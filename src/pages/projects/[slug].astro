---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'

export const prerender = true

export async function getStaticPaths() {
  const projectEntries = await getCollection('projects').catch(() => [])
  if (!projectEntries || projectEntries.length === 0) {
    return []
  }
  return projectEntries.map((entry) => {
    // Generate slug from the entry.id (filename without extension)
    const slug = entry.id.replace(/\.(md|mdx)$/, '')
    return {
      params: { slug },
      props: { entry },
    }
  })
}

const { entry } = Astro.props

// Format date
const formatDate = (date) => {
  if (!date) return ''
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  })
}

let Content
let renderError = null

try {
  if (entry) {
    const rendered = await render(entry)
    Content = rendered.Content
  } else {
    renderError = 'No content available'
  }
} catch (error) {
  renderError = error.message
}
---

<BaseLayout title={entry?.data.title ?? 'Project not found'}>
  {
    entry ? (
      <article class="max-w-3xl mx-auto">
        <div class="mb-8">
          <h1 class="text-4xl font-bold mb-3">{entry.data.title}</h1>
          <p class="text-zinc-600 dark:text-zinc-400 mb-4">
            {entry.data.description}
          </p>

          {entry.data.tech && entry.data.tech.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {entry.data.tech.map((tech) => (
                <span class="bg-zinc-100 dark:bg-zinc-800 text-xs px-2 py-1 rounded">
                  {tech}
                </span>
              ))}
            </div>
          )}

          <div class="flex flex-wrap gap-4 text-sm">
            {entry.data.pubDate && (
              <time
                datetime={new Date(entry.data.pubDate).toISOString()}
                class="text-zinc-500"
              >
                {formatDate(entry.data.pubDate)}
              </time>
            )}

            {entry.data.repo && (
              <a
                href={entry.data.repo}
                target="_blank"
                rel="noopener noreferrer"
                class="text-accent hover:underline"
              >
                View Repository
              </a>
            )}

            {entry.data.liveDemo && (
              <a
                href={entry.data.liveDemo}
                target="_blank"
                rel="noopener noreferrer"
                class="text-accent hover:underline"
              >
                Live Demo
              </a>
            )}
          </div>
        </div>

        {entry.data.cover && (
          <img
            src={entry.data.cover}
            alt={`Screenshot of ${entry.data.title}`}
            class="w-full h-auto rounded-lg mb-8 shadow-md"
          />
        )}

        <div class="prose prose-zinc dark:prose-invert max-w-none">
          {
            renderError ? (
              <div class="bg-red-900/20 border border-red-500 text-red-200 p-4 rounded-lg">
                <h3 class="font-bold">Content Rendering Error:</h3>
                <p>{renderError}</p>
              </div>
            ) : Content ? (
              <Content />
            ) : (
              <p>No content available</p>
            )
          }
        </div>

        <div class="mt-12 pt-8 border-t border-zinc-200 dark:border-zinc-800">
          <a
            href="/projects"
            class="flex items-center text-accent hover:underline"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              fill="currentColor"
              viewBox="0 0 16 16"
              class="mr-1"
            >
              <path
                fill-rule="evenodd"
                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"
              />
            </svg>
            Back to all projects
          </a>
        </div>
      </article>
    ) : (
      <div class="text-center py-20">
        <h1 class="text-4xl font-bold mb-4">Project Not Found</h1>
        <p class="text-lg text-gray-300">
          Sorry, we couldn't find the project you were looking for.
        </p>
      </div>
    )
  }
</BaseLayout>

